name: Deploy CDK Stacks

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  AWS_REGION: us-east-1  # Change to your preferred region

jobs:
  # Stage 1: Checkout & Setup
  checkout:
    name: "Stage 1: Checkout & Setup"
    runs-on: ubuntu-latest
    outputs:
      artifact-id: ${{ steps.upload.outputs.artifact-id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Upload workspace
      id: upload
      uses: actions/upload-artifact@v4
      with:
        name: workspace-${{ github.run_id }}
        path: |
          .
          !node_modules/.cache
        retention-days: 1

  # Stage 2: Tests
  tests:
    name: "Stage 2: Run Tests"
    runs-on: ubuntu-latest
    needs: checkout
    
    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace-${{ github.run_id }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests
      run: npm test
      continue-on-error: false
    
    - name: Run linting
      run: npm run lint
      continue-on-error: true
    
    - name: Run type checking
      run: npm run build
      continue-on-error: false

  # Stage 3: Plan (CDK Synth & Diff)
  plan:
    name: "Stage 3: Plan Changes"
    runs-on: ubuntu-latest
    needs: [checkout, tests]
    
    permissions:
      id-token: write
      contents: read
      pull-requests: write  # To comment on PRs
    
    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace-${{ github.run_id }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::381492077721:role/Github_Actions_Role
        role-session-name: github-actions
        aws-region: us-east-1
    
    - name: Install CDK CLI
      run: npm install -g aws-cdk
    
    - name: CDK Synth
      run: cdk synth --all
    
    - name: CDK Diff
      id: diff
      run: |
        echo "## CDK Plan Output" > diff-output.md
        echo '```' >> diff-output.md
        cdk diff --all >> diff-output.md 2>&1 || true
        echo '```' >> diff-output.md
        
        # Save diff for approval step
        cdk diff --all > cdk-diff.txt 2>&1 || true
    
    - name: Upload CDK plan
      uses: actions/upload-artifact@v4
      with:
        name: cdk-plan-${{ github.run_id }}
        path: |
          cdk.out/
          cdk-diff.txt
        retention-days: 1
    
    - name: Comment PR with plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const diffOutput = fs.readFileSync('diff-output.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: diffOutput
          });

  # Stage 4: Manual Approval (only for main branch)
  approval:
    name: "Stage 4: Approve Deployment"
    runs-on: ubuntu-latest
    needs: [checkout, tests, plan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://sayaji.dev  # Your main website URL
    
    steps:
    - name: Download CDK plan
      uses: actions/download-artifact@v4
      with:
        name: cdk-plan-${{ github.run_id }}
    
    - name: Display planned changes
      run: |
        echo "## Planned Changes:"
        echo "Please review the changes below before approving:"
        echo ""
        cat cdk-diff.txt || echo "No changes detected"
    
    - name: Manual approval checkpoint
      run: |
        echo "âœ… Deployment approved!"
        echo "Proceeding to deploy the following stacks:"
        echo "- BaseInfraStack"
        echo "- BackendStack"  
        echo "- resume.sayaji.dev"
        echo "- sayaji.dev"
        echo "- blog.sayaji.dev"

  # Stage 5: Deploy
  deploy:
    name: "Stage 5: Deploy to Production"
    runs-on: ubuntu-latest
    needs: [checkout, tests, plan, approval]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace-${{ github.run_id }}
    
    - name: Download CDK plan
      uses: actions/download-artifact@v4
      with:
        name: cdk-plan-${{ github.run_id }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-Deploy
    
    - name: Install CDK CLI
      run: npm install -g aws-cdk
    
    - name: Check CDK Bootstrap status
      run: |
        echo "ğŸ” Checking CDK bootstrap status..."
        if aws cloudformation describe-stacks --stack-name CDKToolkit --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
          echo "âœ… CDK already bootstrapped, skipping..."
        else
          echo "ğŸš€ Bootstrapping CDK for the first time..."
          cdk bootstrap
        fi
    
    - name: CDK Deploy
      run: |
        echo "ğŸš€ Deploying CDK stacks..."
        cdk deploy --all --require-approval never --verbose
        echo "âœ… Deployment completed successfully!"
    
    - name: Post-deployment validation
      run: |
        echo "ğŸ” Running post-deployment checks..."
        # Add any validation commands here
        # curl -f https://sayaji.dev || exit 1
        # curl -f https://resume.sayaji.dev || exit 1
        # curl -f https://blog.sayaji.dev || exit 1
        echo "âœ… All checks passed!"

  # Summary job
  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [checkout, tests, plan, approval, deploy]
    if: always() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## ğŸ“‹ Deployment Summary"
        echo "- Checkout: ${{ needs.checkout.result }}"
        echo "- Tests: ${{ needs.tests.result }}"  
        echo "- Plan: ${{ needs.plan.result }}"
        echo "- Approval: ${{ needs.approval.result }}"
        echo "- Deploy: ${{ needs.deploy.result }}"
        
        if [[ "${{ needs.deploy.result }}" == "success" ]]; then
          echo "ğŸ‰ Deployment completed successfully!"
        else
          echo "âŒ Deployment failed or was cancelled"
        fi
